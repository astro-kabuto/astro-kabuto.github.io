<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gallery | Astro Kabuto</title>
  <link rel="stylesheet" href="style.css">

  <style>
    /* ===== Paper tone base ===== */
    :root{
      --paper:#f3efe7;
      --paper2:#efe8dc;
      --ink: rgba(0,0,0,.82);
      --muted: rgba(0,0,0,.58);
      --line: rgba(0,0,0,.10);

      --card:#ffffffcc;
      --shadow: 0 18px 55px rgba(0,0,0,.10);
      --shadowHover: 0 26px 75px rgba(0,0,0,.14);

      --radius-xl: 22px;
      --radius-lg: 18px;
      --radius-md: 14px;
    }

    body{
      background:
        radial-gradient(1200px 500px at 20% 10%, rgba(255,255,255,.65), transparent 60%),
        radial-gradient(900px 400px at 85% 0%, rgba(255,255,255,.55), transparent 55%),
        linear-gradient(180deg, var(--paper), var(--paper2));
    }

    main.wrap{ padding-top: 16px; }
    main.wrap > h1{ margin: 6px 0 0; letter-spacing: -0.02em; }
    main.wrap > .sub{ margin-top: 6px; }

    /* ===== Keep your header dark (existing tone) ===== */
    .header{
      background: rgba(0,0,0,.42);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.14);
    }
    .header .brand-text h1,
    .header .brand-text p,
    .header .nav a{
      color:#fff;
      text-shadow: 0 2px 12px rgba(0,0,0,.75);
    }
    .header .nav a{ opacity: .92; }
    .header .nav a:hover{ opacity: 1; }

    /* ===== Illustrated-like banner ===== */
    .gBanner{
      border: 1px solid rgba(0,0,0,.08);
      border-radius: var(--radius-xl);
      overflow: hidden;
      background:
        linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.20)),
        radial-gradient(700px 220px at 15% 20%, rgba(255,255,255,.65), transparent 70%),
        radial-gradient(700px 220px at 85% 0%, rgba(255,255,255,.55), transparent 70%);
      box-shadow: 0 18px 60px rgba(0,0,0,.10);
      padding: 18px 18px 14px;
      margin: 10px 0 14px;
      position: relative;
    }
    .gBanner h1{
      margin: 0;
      font-size: 26px;
      letter-spacing: -0.02em;
      font-weight: 900;
      color: rgba(0,0,0,.80);
    }
    .gBanner p{
      margin: 6px 0 0;
      color: rgba(0,0,0,.60);
      font-size: 13px;
      line-height: 1.6;
    }

    /* ===== Toolbar ===== */
    .gToolbar{
      margin: 12px 0 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(10px);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 18px 55px rgba(0,0,0,.08);
      position: sticky;
      top: 92px;
      z-index: 40;
    }
    .gRow{ display:flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .gSearch{
      flex: 1 1 280px;
      height: 44px;
      border-radius: 14px;
      padding: 0 14px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.85);
      font-size: 13px;
      color: var(--ink);
      outline: none;
    }
    .gSearch:focus{
      border-color: rgba(0,0,0,.18);
      box-shadow: 0 0 0 4px rgba(0,0,0,.06);
    }
    .gSelect, .gBtn{
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.85);
      font-size: 13px;
      padding: 0 12px;
      color: var(--ink);
    }
    .gBtn{ cursor:pointer; }
    .gBtn:hover{ filter: brightness(.99); }

    .gPillBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 44px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.85);
      color: rgba(0,0,0,.72);
      text-decoration: none;
      font-size: 13px;
      font-weight: 900;
      letter-spacing: .02em;
      cursor: pointer;
      user-select: none;
    }
    .gPillBtn.primary{
      background: rgba(0,113,227,.12);
      border-color: rgba(0,113,227,.18);
      color: rgba(0,70,160,.88);
    }

    /* ===== Chips ===== */
    .gChips{ display:flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .gChip{
      padding: 6px 11px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.65);
      color: rgba(0,0,0,.62);
      font-size: 12px;
      cursor: pointer;
      transition: transform .14s ease, filter .14s ease, background .14s ease;
    }
    .gChip:hover{ transform: translateY(-1px); filter: brightness(.99); }
    .gChip.is-active{
      background: rgba(0,0,0,.06);
      border-color: rgba(0,0,0,.12);
      color: rgba(0,0,0,.86);
    }

    .gMeta{ margin: 10px 0 0; font-size: 12px; color: rgba(0,0,0,.58); }
    .gEmpty{ margin: 14px 0 0; color: rgba(0,0,0,.58); font-size: 13px; }

    /* ===== TODAY'S PICK ===== */
    .gFeatured{
      margin: 10px 0 16px;
      border-radius: var(--radius-xl);
      overflow: hidden;
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 18px 60px rgba(0,0,0,.10);
      background: #f5f5f7;
      position: relative;
      aspect-ratio: 16 / 9;
      cursor: pointer;
      transition: box-shadow .18s ease, transform .18s ease;
    }
    .gFeatured:hover{ transform: translateY(-1px); box-shadow: 0 26px 85px rgba(0,0,0,.14); }
    .gFeatured::before{
      content:"";
      position:absolute;
      inset:0;
      background: var(--featured-bg) center / cover no-repeat;
      filter: blur(14px) brightness(.92);
      transform: scale(1.10);
      z-index: 0;
      pointer-events:none;
    }
    .gFeatured::after{
      content:"";
      position:absolute;
      inset:0;
      z-index: 2;
      background: linear-gradient(
        to right,
        rgba(0,0,0,.62),
        rgba(0,0,0,.28) 45%,
        rgba(0,0,0,0) 72%
      );
      pointer-events:none;
    }
    .gFeatured img{
      width: 100%;
      height: 100%;
      display: block;
      object-fit: contain;
      object-position: center;
      position: relative;
      z-index: 1;
      background: transparent;
      padding: clamp(14px, 2.2vw, 28px);
      box-sizing: border-box;
    }
    .gFeatured-info{
      position:absolute;
      left: 18px;
      bottom: 16px;
      z-index: 3;
      color: #fff;
      text-shadow: 0 18px 40px rgba(0,0,0,.85);
      max-width: min(70%, 560px);
    }
    .gFeatured-kicker{
      color: rgba(255,255,255,.92);
      font-weight: 900;
      letter-spacing: .18em;
      display: inline-block;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(0,0,0,.26);
      border: 1px solid rgba(255,255,255,.12);
      margin: 0 0 10px;
      font-size: 12px;
    }
    .gFeatured-title{
      color: #fff;
      font-weight: 900;
      margin: 0 0 7px;
      font-size: 20px;
      letter-spacing: -0.01em;
    }
    .gFeatured-sub{
      color: rgba(255,255,255,.92);
      font-weight: 700;
      margin: 0;
      font-size: 12px;
      opacity: .95;
    }

    /* â˜… è¿½åŠ ï¼šãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„/å¤±æ•—æ™‚ã«featuredã‚’ç•³ã‚€ï¼ˆè¦‹ãŸç›®å´©å£Šé˜²æ­¢ï¼‰ */
    body.is-empty #gFeatured{ display:none; }
    body.load-failed #gFeatured{
      aspect-ratio: auto;
      height: 180px;
      cursor: default;
    }
    body.load-failed #gFeatured::after{
      background: linear-gradient(to right, rgba(0,0,0,.55), rgba(0,0,0,.10) 55%, rgba(0,0,0,0) 85%);
    }

    /* ===== Card grid ===== */
    .grid{ display:grid; gap: 16px; margin-top: 12px; }
    @media (min-width: 920px){ .grid{ grid-template-columns: repeat(3, 1fr); } }
    @media (min-width: 1240px){ .grid{ grid-template-columns: repeat(4, 1fr); } }
    @media (max-width: 919px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 560px){ .grid{ grid-template-columns: 1fr; } }

    .gCard{
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.62);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
      cursor: pointer;
    }
    .gCard:hover{
      transform: translateY(-2px);
      box-shadow: var(--shadowHover);
      filter: saturate(1.02) contrast(1.01);
    }

    .gCardTop{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 10px 10px 8px;
      gap: 10px;
    }
    .gUser{
      display:flex;
      align-items:center;
      gap: 8px;
      min-width: 0;
    }
    .gAvatar{
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: rgba(0,0,0,.08);
      border: 1px solid rgba(0,0,0,.10);
      flex: 0 0 auto;
      display:grid;
      place-items:center;
      font-size: 12px;
      color: rgba(0,0,0,.55);
      font-weight: 900;
    }
    .gName{
      font-weight: 900;
      color: rgba(0,0,0,.78);
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .gSubName{
      font-size: 11px;
      color: rgba(0,0,0,.52);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .gFlagLike{
      display:flex;
      align-items:center;
      gap: 8px;
      flex: 0 0 auto;
    }
    .gFlag{ font-size: 14px; opacity: .9; }
    .gLikes{
      display:flex;
      align-items:center;
      gap: 6px;
      font-size: 11px;
      color: rgba(0,0,0,.58);
      white-space: nowrap;
    }

    .gThumbWrap{
      border-top: 1px solid rgba(0,0,0,.08);
      border-bottom: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.75);
    }
    .gThumb{
      width: 100%;
      height: 210px;
      display:block;
      object-fit: contain;
      object-position: center;
      padding: 10px;
      box-sizing: border-box;
    }

    .gCardBody{ padding: 10px 12px 12px; }
    .gCaption{
      margin: 0 0 8px;
      font-size: 12px;
      color: rgba(0,0,0,.68);
      line-height: 1.55;
      min-height: 2.9em;
    }
    .gFoot{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      color: rgba(0,0,0,.52);
      font-size: 11px;
    }
    .gTagPills{ display:flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .gTagPill{
      font-size: 11px;
      color: rgba(0,0,0,.58);
      background: rgba(0,0,0,.04);
      border: 1px solid rgba(0,0,0,.08);
      padding: 4px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .gMonth{
      grid-column: 1 / -1;
      margin: 6px 0 0;
      padding: 9px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.55);
      color: rgba(0,0,0,.62);
      font-size: 12px;
      letter-spacing: .08em;
    }

    /* ===== More button ===== */
    .gMoreWrap{ display:flex; justify-content:center; margin: 18px 0 30px; }
    .gMoreBtn{
      height: 44px;
      padding: 0 18px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.70);
      font-weight: 900;
      cursor: pointer;
      color: rgba(0,0,0,.70);
      box-shadow: 0 14px 35px rgba(0,0,0,.08);
    }

    /* ===== Lightbox ===== */
    .lightbox{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,.86);
      z-index: 9999;
      padding: 24px;
      touch-action: none;
    }
    .lightbox.open{ display:flex; }

    .lightbox-figure{
      position: relative;
      margin: 0;
      max-width: min(1100px, 92vw);
      max-height: 86vh;
      display: grid;
      justify-items: center;
    }
    #lightboxImg{
      max-width: min(1100px, 92vw);
      max-height: 78vh;
      width: auto;
      height: auto;
      object-fit: contain;
      display: block;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    .lightbox-cap{ margin-top: 10px; color: rgba(255,255,255,.86); font-size: 12px; }
    .lightbox-close{
      position: absolute;
      top: -10px;
      right: -10px;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      color: #fff;
      font-size: 22px;
      cursor: pointer;
      z-index: 2;
    }
    .lightbox-btn{
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      color: #fff;
      font-size: 28px;
      line-height: 1;
      cursor: pointer;
      z-index: 2;
    }
    .lightbox-btn.prev{ left: 14px; }
    .lightbox-btn.next{ right: 14px; }
    body.lb-open{ overflow: hidden; }

    .lbPanel{
      margin-top: 12px;
      max-width: min(900px, 92vw);
      color: rgba(255,255,255,.92);
      font-size: 12px;
      line-height: 1.6;
    }
    .lbTitle{ font-size: 13px; font-weight: 900; margin-bottom: 6px; opacity: .98; }
    .lbPills{ display:flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
    .lbPill{
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      font-size: 11px;
      opacity: .95;
    }
    .lbNote{ opacity: .9; white-space: pre-wrap; }

    @media (max-width: 740px){
      .gToolbar{ top: 74px; }
      .gFeatured{ aspect-ratio: 4 / 3; }
      .gThumb{ height: 220px; }
      .lightbox{ padding: 14px; }
      .lightbox-btn{ width: 40px; height: 40px; font-size: 26px; }
      .lightbox-btn.prev{ left: 10px; }
      .lightbox-btn.next{ right: 10px; }
    }

    /* =========================================
       ã€PATCHã€‘Gallery readability upgrade
       æœ«å°¾ã«è¿½è¨˜ã™ã‚‹ã ã‘ã§OK
    ========================================= */

    /* 1) ãƒšãƒ¼ã‚¸å…¨ä½“ã®æ¨ªå¹…ã‚’æ•´ãˆã¦ä½™ç™½ã‚’æœ€é©åŒ– */
    main.wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding-left: 16px;
      padding-right: 16px;
    }

    /* 2) Bannerã¯å°‘ã—ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
    .gBanner{
      padding: 16px 16px 12px;
    }
    .gBanner h1{ font-size: 24px; }
    .gBanner p{ font-size: 13px; }

    /* 3) TODAY'S PICK ã‚’ â€œã¡ã‚‡ã†ã©è‰¯ã„é«˜ã•â€ ã« */
    .gFeatured{
      aspect-ratio: 21 / 9;          /* 16/9ã‚ˆã‚Šæ¨ªé•·ã§é«˜ã•ã‚’æŠ‘ãˆã‚‹ */
      min-height: 220px;
    }
    @media (max-width: 740px){
      .gFeatured{ aspect-ratio: 16 / 10; min-height: 200px; }
    }
    .gFeatured img{
      object-fit: cover;              /* containâ†’coverã§è¿«åŠ›UP */
      padding: 0;                     /* ä½™ç™½ã‚’æ¸›ã‚‰ã—ã¦å¤§ããè¦‹ã›ã‚‹ */
    }
    .gFeatured::before{
      filter: blur(18px) brightness(.86);
    }
    .gFeatured-info{
      left: 16px;
      bottom: 14px;
    }
    .gFeatured-title{ font-size: 18px; margin: 0 0 6px; }
    .gFeatured-sub{ font-size: 12px; opacity: .92; }

    /* 4) Toolbarã‚’ã‚¹ãƒªãƒ ï¼†è¦‹ã‚„ã™ãï¼ˆstickyã®åœ§ã‚’æ¸›ã‚‰ã™ï¼‰ */
    .gToolbar{
      padding: 10px;
      border-radius: 16px;
      background: rgba(255,255,255,.50);
      box-shadow: 0 14px 40px rgba(0,0,0,.07);
    }
    .gRow{ gap: 8px; }
    .gSearch{
      height: 42px;
      border-radius: 12px;
      font-size: 13px;
    }
    .gSelect, .gBtn{ height: 42px; border-radius: 12px; }
    .gPillBtn{ height: 42px; }

    /* chipsã¯å°‘ã—å°ã•ã‚ï¼†è¡Œã‚’è©°ã‚ã‚‹ */
    .gChips{ gap: 7px; margin-top: 8px; }
    .gChip{ padding: 6px 10px; font-size: 12px; }

    /* 5) ã‚°ãƒªãƒƒãƒ‰ã‚’ â€œè‡ªç„¶ã«å¢—æ¸›â€ ã•ã›ã¦æ•´åˆ—æ„ŸUP */
    .grid{
      gap: 14px;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    }
    @media (max-width: 560px){
      .grid{ grid-template-columns: 1fr; }
    }

    /* 6) ã‚«ãƒ¼ãƒ‰ã®è¦‹ã‚„ã™ã•ï¼ˆæ–‡å­—ã¨ä½™ç™½ã®æœ€é©åŒ–ï¼‰ */
    .gCard{
      border-radius: 18px;
      box-shadow: 0 14px 40px rgba(0,0,0,.08);
    }
    .gCardTop{
      padding: 10px 10px 8px;
    }
    .gAvatar{
      width: 28px; height: 28px;
      font-size: 12px;
    }
    .gName{ font-size: 13px; }
    .gSubName{ font-size: 11px; }

    /* 7) ã‚µãƒ ãƒã‚’ â€œå¤§ããè¦‹ã›ã‚‹â€ */
    .gThumbWrap{
      background: rgba(255,255,255,.80);
    }
    .gThumb{
      height: 240px;                 /* 210â†’240ã§å°‘ã—å¤§ãã */
      padding: 0;                    /* ä½™ç™½ã‚’æ¸›ã‚‰ã™ */
      object-fit: cover;             /* containâ†’cover */
    }
    @media (max-width: 740px){
      .gThumb{ height: 260px; }
    }
    @media (max-width: 560px){
      .gThumb{
        object-fit: contain;         /* ã‚¹ãƒãƒ›ã¯åˆ‡ã‚Œãªã„æ–¹ãŒå¥½ããªã‚‰containã« */
        background: rgba(255,255,255,.85);
      }
    }

    /* 8) æœ¬æ–‡ã‚’èª­ã¿ã‚„ã™ã */
    .gCardBody{ padding: 10px 12px 12px; }
    .gCaption{
      font-size: 13px;               /* 12â†’13 */
      line-height: 1.6;
      min-height: 0;                 /* å›ºå®šé«˜ã‚’å¤–ã—ã¦è©°ã‚ã‚‹ */
    }
    .gFoot{ font-size: 11px; }
    .gTagPill{ font-size: 11px; }

    /* 9) æœˆè¦‹å‡ºã—ã‚’å°‘ã—ç›®ç«‹ãŸã›ã‚‹ */
    .gMonth{
      padding: 10px 12px;
      font-weight: 900;
      background: rgba(255,255,255,.60);
    }

    /* 10) â€œã‚‚ã£ã¨è¦‹ã‚‹â€ãƒœã‚¿ãƒ³ã‚’å°‘ã—å¼·ã‚ã« */
    .gMoreBtn{
      height: 46px;
      border-radius: 14px;
      background: rgba(255,255,255,.78);
      box-shadow: 0 16px 45px rgba(0,0,0,.08);
    }

    /* âœ… ã„ã„ã­ãƒœã‚¿ãƒ³: æŠ¼ã—ãŸæ™‚ã®è¦–è¦š */
    .gPillBtn[data-like]{
      transition: transform .12s ease, filter .12s ease, background .12s ease;
    }
    .gPillBtn[data-like].is-liked{
      background: rgba(255, 0, 70, .14);
      border-color: rgba(255, 0, 70, .20);
      color: rgba(180, 0, 50, .90);
    }
    .gPillBtn[data-like]:active{
      transform: scale(.97);
    }

  </style>
</head>

<body>
  <header class="topbar">
    <div class="shell topbar-inner">
      <a class="brand" href="index.html" aria-label="Home">
        <span class="brand-kanji">å…œ</span>
        <span class="brand-name">KABUTOMARU</span>
      </a>

      <nav class="nav" aria-label="Primary">
        <a class="active" href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="gallery.html">Gallery</a>
        <a href="care.html">Care Tips</a>
        
      </nav>

      <div class="social" aria-label="Social">
        <a class="sbtn" href="#" aria-label="Facebook">f</a>
        <a class="sbtn" href="#" aria-label="X">x</a>
        <a class="sbtn" href="#" aria-label="Instagram">â—</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="gBanner" aria-label="Gallery intro">
      <h1>å…œä¸¸ã‚®ãƒ£ãƒ©ãƒªãƒ¼</h1>
      <p>ä¸–ç•Œä¸­ã®å…œä¸¸å†™çœŸã‚’ãƒã‚§ãƒƒã‚¯ï¼ã„ã¾ã¯ <b>kiji</b> ã®å†™çœŸã®ã¿ã€‚å°†æ¥ã¯ã¿ã‚“ãªãŒæŠ•ç¨¿ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚</p>
    </section>

    <!-- TODAY'S PICK -->
    <section class="gFeatured" id="gFeatured" aria-label="Today pick">
      <img id="gFeaturedImg" src="" alt="ä»Šæ—¥ã®ãŠã™ã™ã‚">
      <div class="gFeatured-info">
        <p class="gFeatured-kicker">TODAYâ€™S PICK</p>
        <p class="gFeatured-title" id="gFeaturedTitle">ä»Šæ—¥ã®å…œ</p>
        <p class="gFeatured-sub" id="gFeaturedSub">ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§è¡¨ç¤º</p>
      </div>
    </section>

    <!-- Toolbar -->
    <section class="gToolbar" aria-label="Gallery toolbar">
      <div class="gRow">
        <input id="gSearch" class="gSearch" type="search" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ï¼ˆä¾‹ï¼šsuper / 2026-01 / iswï¼‰" autocomplete="off">
        <select id="gType" class="gSelect" aria-label="Category">
          <option value="all">ã‚«ãƒ†ã‚´ãƒªï¼šã™ã¹ã¦</option>
          <option value="normal">é€šå¸¸å…œ</option>
          <option value="super">ã‚¹ãƒ¼ãƒ‘ãƒ¼å…œ</option>
          <option value="ruri">ç‘ ç’ƒå…œ</option>
          <option value="miracle">ãƒŸãƒ©ã‚¯ãƒ«å…œ</option>
          <option value="isw">ISWå…œ</option>
          <option value="fav">â™¡ ãŠæ°—ã«å…¥ã‚Š</option>
        </select>
        <select id="gSort" class="gSelect" aria-label="Sort">
          <option value="new">æ–°ã—ã„é †</option>
          <option value="old">å¤ã„é †</option>
        </select>
        <button id="gReset" class="gBtn" type="button">ãƒªã‚»ãƒƒãƒˆ</button>

        <!-- âœ… æŠ•ç¨¿ãƒšãƒ¼ã‚¸ã¸ -->
        <a class="gPillBtn primary" id="postBtn" href="upload.html">æŠ•ç¨¿ã™ã‚‹</a>
      </div>

      <div class="gChips" role="group" aria-label="Filter chips">
        <button class="gChip is-active" data-filter="all" type="button">ã™ã¹ã¦</button>
        <button class="gChip" data-filter="normal" type="button">é€šå¸¸å…œ</button>
        <button class="gChip" data-filter="super" type="button">ã‚¹ãƒ¼ãƒ‘ãƒ¼å…œ</button>
        <button class="gChip" data-filter="ruri" type="button">ç‘ ç’ƒå…œ</button>
        <button class="gChip" data-filter="miracle" type="button">ãƒŸãƒ©ã‚¯ãƒ«å…œ</button>
        <button class="gChip" data-filter="isw" type="button">ISWå…œ</button>
        <button class="gChip" data-filter="fav" type="button">â™¡ ãŠæ°—ã«å…¥ã‚Š</button>
      </div>

      <p class="gMeta"><span id="gCount"></span></p>
      <p id="gEmpty" class="gEmpty" hidden>æ¡ä»¶ã«åˆã†å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    </section>

    <div id="grid" class="grid" aria-label="Gallery grid"></div>

    <div class="gMoreWrap">
      <button id="gMore" class="gMoreBtn" type="button">ã‚‚ã£ã¨è¦‹ã‚‹ â†’</button>
    </div>
  </main>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" aria-hidden="true">
    <button class="lightbox-btn prev" id="lightboxPrev" aria-label="Prev">â€¹</button>
    <figure class="lightbox-figure">
      <button class="lightbox-close" id="lightboxClose" aria-label="Close">Ã—</button>
      <img id="lightboxImg" alt="">
      <figcaption id="lightboxCap" class="lightbox-cap"></figcaption>
      <div id="lbPanel" class="lbPanel" aria-live="polite"></div>
    </figure>
    <button class="lightbox-btn next" id="lightboxNext" aria-label="Next">â€º</button>
  </div>

  <script>
    // ================================
    // Worker è¨­å®š
    // ================================
    const WORKER_ORIGIN = "https://astro-kabuto-gallery-worker.gigasantrinn1226.workers.dev";
    const R2_FILES = `${WORKER_ORIGIN}/files/`;

    // ã‚¹ãƒšãƒ¼ã‚¹ã‚„()ãŒå…¥ã£ã¦ã‚‚å®‰å…¨ãªURLã«ã™ã‚‹
    const r2 = (key) => R2_FILES + encodeURIComponent(key);

    // ================================
    // â¤ï¸ Like API helpers
    // ================================
    async function fetchLikesMap(ids){
      // ids: string[]
      const unique = Array.from(new Set(ids.filter(Boolean)));
      if (!unique.length) return { counts:{}, liked:{} };

      // URLé•·ã•å¯¾ç­–ï¼šä¸€å¿œ chunk
      const chunkSize = 120;
      const counts = {};
      const liked = {};

      for (let i=0; i<unique.length; i+=chunkSize){
        const part = unique.slice(i, i+chunkSize);
        const qs = encodeURIComponent(part.join(","));
        const res = await fetch(`${WORKER_ORIGIN}/api/likes?ids=${qs}`, { cache:"no-store" });
        if (!res.ok) throw new Error("likes fetch failed: " + res.status);
        const data = await res.json();
        Object.assign(counts, data.counts || {});
        Object.assign(liked, data.liked || {});
      }
      return { counts, liked };
    }

    async function toggleLike(postId){
      const res = await fetch(`${WORKER_ORIGIN}/api/like`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ post_id: postId })
      });
      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error(data?.error || "like failed");
      // { ok:true, liked:true/false, likes:number }
      return data;
    }

    // ================================
    // âœ… v=2ï¼ˆtitle/tag/noteå…¥ã‚Šï¼‰ã‚’èª­ã‚€
    // ================================
    async function loadPosts(){
      const res = await fetch(`${WORKER_ORIGIN}/list?v=2`, { cache: "no-store" });
      if (!res.ok) throw new Error(`list failed: ${res.status}`);

      const data = await res.json(); // { ok:true, items:[{id,r2_key,created_at,caption}, ...] }
      const items = data.items || [];

      return items.map((row) => {
        let meta = {};
        try { meta = JSON.parse(row.caption || "{}"); } catch {}

        const title = (meta.title || "").toString();
        const tag = (meta.tag || "").toString();
        const note = (meta.note || "").toString();
        const images = Array.isArray(meta.images) ? meta.images : [];

        const key = row.r2_key;
        const lowerKey = String(key).toLowerCase();

        // æ—¥ä»˜ï¼šã‚­ãƒ¼å…ˆé ­ or created_at
        const m = String(key).match(/^(\d{4}-\d{2}-\d{2})/);
        const date = m ? m[1] : (row.created_at ? row.created_at.slice(0,10) : "0000-00-00");

        // typeï¼štagå„ªå…ˆã€ãªã‘ã‚Œã°ãƒ•ã‚¡ã‚¤ãƒ«åæ¨å®š
        let type = "normal";
        const t = tag.toLowerCase();
        if (t === "super") type = "super";
        else if (t === "ruri") type = "ruri";
        else if (t === "miracle") type = "miracle";
        else if (t === "isw") type = "isw";
        else {
          if (lowerKey.includes("super")) type = "super";
          else if (lowerKey.includes("ruri")) type = "ruri";
          else if (lowerKey.includes("miracle")) type = "miracle";
          else if (lowerKey.includes("isw")) type = "isw";
        }

        return {
          id: row.id,
          src: r2(key),
          cultivar: "å…œä¸¸ï¼ˆAstrophytum asteriasï¼‰",
          date,
          author: "kiji",
          country: "JP",
          type,

          caption: title || "(no title)", // ã‚¿ã‚¤ãƒˆãƒ«
          note,
          tag,
          images,

          // â¤ï¸ like (server)
          likes: 0,
          liked: false,

          tags: [ tag ? `#${tag}` : "#å…œã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³" ],
        };
      });
    }

    // ====== UI elements ======
    const grid = document.getElementById("grid");
    const featured = document.getElementById("gFeatured");
    const featuredImg = document.getElementById("gFeaturedImg");
    const featuredTitle = document.getElementById("gFeaturedTitle");
    const featuredSub = document.getElementById("gFeaturedSub");

    const searchEl = document.getElementById("gSearch");
    const typeSel = document.getElementById("gType");
    const sortEl = document.getElementById("gSort");
    const resetEl = document.getElementById("gReset");
    const chips = Array.from(document.querySelectorAll(".gChip"));
    const countEl = document.getElementById("gCount");
    const emptyEl = document.getElementById("gEmpty");
    const moreBtn = document.getElementById("gMore");

    // ====== state ======
    let allPosts = [];
    let filtered = [];
    let activeType = "all";
    let shown = 8;

    const typeLabel = (t)=>({
      normal:"é€šå¸¸å…œ", super:"ã‚¹ãƒ¼ãƒ‘ãƒ¼å…œ", ruri:"ç‘ ç’ƒå…œ", miracle:"ãƒŸãƒ©ã‚¯ãƒ«å…œ", isw:"ISWå…œ"
    }[t] || "å…œ");

    const countryFlag = (c)=>({
      JP:"ğŸ‡¯ğŸ‡µ", US:"ğŸ‡ºğŸ‡¸", DE:"ğŸ‡©ğŸ‡ª", GB:"ğŸ‡¬ğŸ‡§"
    }[c] || "ğŸŒ");

    const monthLabel = (dateStr)=> (dateStr && dateStr.length>=7) ? dateStr.slice(0,7) : "---- --";

    // âœ… æ¤œç´¢å¯¾è±¡ã« note/tag ã‚‚å…¥ã‚Œã‚‹
    function textOf(p){
      const tags = (p.tags||[]).join(" ");
      const extra = `${p.note||""} ${p.tag||""}`;
      return `${p.cultivar||""} ${p.date||""} ${p.author||""} ${p.type||""} ${p.caption||""} ${tags} ${extra}`.toLowerCase();
    }

    function sortPosts(arr){
      return arr.slice().sort((a,b)=>{
        const da = a.date || "0000-00-00";
        const db = b.date || "0000-00-00";
        return (sortEl.value === "new") ? db.localeCompare(da) : da.localeCompare(db);
      });
    }

    function applyFilters(){
      const q = (searchEl.value||"").trim().toLowerCase();

      filtered = allPosts.filter(p=>{
        const matchFav = !!p.liked; // âœ… è‡ªåˆ†ãŒã„ã„ã­ã—ãŸæŠ•ç¨¿
        const matchType =
          (activeType === "all") ||
          (activeType === "fav" ? matchFav : p.type === activeType);

        const matchSel =
          (typeSel.value === "all") ||
          (typeSel.value === "fav" ? matchFav : p.type === typeSel.value);

        const matchText = !q || textOf(p).includes(q);
        return matchType && matchSel && matchText;
      });

      filtered = sortPosts(filtered);

      document.body.classList.toggle("is-empty", filtered.length === 0);

      render();
      updateFeatured();
    }

    function render(){
      grid.innerHTML = "";
      const slice = filtered.slice(0, shown);

      let lastMonth = "";
      slice.forEach(p=>{
        const m = monthLabel(p.date);
        if (m !== lastMonth){
          const h = document.createElement("div");
          h.className = "gMonth";
          h.textContent = m;
          grid.appendChild(h);
          lastMonth = m;
        }
        grid.appendChild(cardEl(p));
      });

      countEl.textContent = `${filtered.length}æšä¸­ ${Math.min(shown, filtered.length)}æšè¡¨ç¤º`;
      emptyEl.hidden = filtered.length !== 0;

      moreBtn.style.display = (shown < filtered.length) ? "inline-flex" : "none";
      syncCardHandlers();
    }

    function cardEl(p){
      const el = document.createElement("article");
      el.className = "gCard";
      el.dataset.id = p.id;
      el.dataset.src = p.src;
      el.dataset.cultivar = p.cultivar || "";
      el.dataset.date = p.date || "";
      el.dataset.author = p.author || "";
      el.dataset.type = p.type || "";
      el.dataset.country = p.country || "";
      el.dataset.title = p.caption || "";
      el.dataset.note = p.note || "";
      el.dataset.tag = p.tag || "";
      el.dataset.likes = String(p.likes ?? 0);
      el.dataset.liked = String(!!p.liked);

      const noteLine = (p.note || "").trim();
      const noteShort = noteLine.length > 60 ? noteLine.slice(0,60) + "â€¦" : noteLine;

      const likeMark = p.liked ? "â™¥" : "â™¡";

      el.innerHTML = `
        <div class="gCardTop">
          <div class="gUser">
            <div class="gAvatar">${(p.author||"k").slice(0,1).toUpperCase()}</div>
            <div style="min-width:0;">
              <div class="gName">${escapeHtml(p.author || "unknown")}</div>
              <div class="gSubName">${escapeHtml(typeLabel(p.type))} / ${escapeHtml(p.date || "")}</div>
            </div>
          </div>

          <div class="gFlagLike">
            <span class="gFlag" title="${escapeHtml(p.country||"")}">${countryFlag(p.country)}</span>

            <span class="gLikes" title="likes">
              <span>â™¥</span> <span data-like-count>${escapeHtml(String(p.likes ?? 0))}</span>
            </span>

            <button class="gPillBtn ${p.liked ? "is-liked" : ""}" data-like type="button"
              style="height:34px;padding:0 10px;font-size:12px;">
              ${likeMark}
            </button>
          </div>
        </div>

        <div class="gThumbWrap">
          <img class="gThumb" src="${p.src}" alt="${escapeHtml(p.cultivar||"å…œ")}" loading="lazy" decoding="async">
        </div>

        <div class="gCardBody">
          <p class="gCaption">
            <b>${escapeHtml(p.caption || "ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰")}</b>
            ${noteShort ? `<br><span style="opacity:.78">${escapeHtml(noteShort)}</span>` : ""}
          </p>

          <div class="gFoot">
            <span>${escapeHtml(p.cultivar || "å…œä¸¸")}</span>
            <span>${escapeHtml(typeLabel(p.type))}</span>
          </div>

          <div class="gTagPills">
            ${p.tag ? `<span class="gTagPill">#${escapeHtml(p.tag)}</span>` : ""}
            ${(p.tags||[]).slice(0,2).map(t=>`<span class="gTagPill">${escapeHtml(t)}</span>`).join("")}
          </div>
        </div>
      `;

      // â¤ï¸ like click (server)
      el.querySelector("[data-like]").addEventListener("click", async (e)=>{
        e.preventDefault(); e.stopPropagation();

        const btn = e.currentTarget;
        const countEl = el.querySelector("[data-like-count]");

        // é€£æ‰“é˜²æ­¢
        if (btn.dataset.busy === "1") return;
        btn.dataset.busy = "1";

        const postId = p.id;

        // æ¥½è¦³æ›´æ–°ï¼ˆä½“æ„Ÿã‚ˆãï¼‰
        const wasLiked = !!p.liked;
        p.liked = !wasLiked;
        p.likes = Math.max(0, (p.likes||0) + (p.liked ? 1 : -1));
        btn.textContent = p.liked ? "â™¥" : "â™¡";
        btn.classList.toggle("is-liked", p.liked);
        countEl.textContent = String(p.likes);

        try{
          const res = await toggleLike(postId);
          p.liked = !!res.liked;
          p.likes = Number(res.likes ?? p.likes);
          btn.textContent = p.liked ? "â™¥" : "â™¡";
          btn.classList.toggle("is-liked", p.liked);
          countEl.textContent = String(p.likes);

          // ãƒ•ã‚£ãƒ«ã‚¿ãŒã€Œâ™¡ãŠæ°—ã«å…¥ã‚Šã€ãªã‚‰çµæœã‚’åæ˜ 
          if (activeType === "fav" || typeSel.value === "fav") applyFilters();

          // lightboxãŒé–‹ã„ã¦ã‚‹ãªã‚‰ãƒ‘ãƒãƒ«ã‚‚åŒæœŸ
          if (lightbox.classList.contains("open")) {
            const card = visibleCards()[currentIndex];
            if (card && card.dataset.id === postId){
              card.dataset.likes = String(p.likes);
              card.dataset.liked = String(p.liked);
              setInfoPanel(card);
            }
          }

        }catch(err){
          // æˆ»ã™
          p.liked = wasLiked;
          p.likes = Math.max(0, (p.likes||0) + (wasLiked ? 1 : -1));
          btn.textContent = p.liked ? "â™¥" : "â™¡";
          btn.classList.toggle("is-liked", p.liked);
          countEl.textContent = String(p.likes);
          alert("ã„ã„ã­ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã­ã€‚");
          console.error(err);
        }finally{
          btn.dataset.busy = "0";
        }
      });

      return el;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ===== TODAY pick (daily / JST) =====
    const FEATURED_DAILY_KEY = "astroKabutoFeaturedDaily";
    function todayKeyJST(){
      return new Intl.DateTimeFormat("sv-SE", { timeZone: "Asia/Tokyo" }).format(new Date());
    }
    function pickFeatured(){
      if (!filtered.length) return null;

      const today = todayKeyJST();
      let saved = null;
      try { saved = JSON.parse(localStorage.getItem(FEATURED_DAILY_KEY) || "null"); } catch {}

      if (saved && saved.date === today && saved.id){
        const found = filtered.find(p=>p.id === saved.id);
        if (found) return found;
      }
      const pick = filtered[Math.floor(Math.random() * filtered.length)];
      localStorage.setItem(FEATURED_DAILY_KEY, JSON.stringify({ date: today, id: pick.id }));
      return pick;
    }

    function updateFeatured(){
      const p = pickFeatured();
      if (!p){
        featuredImg.src = "";
        featured.style.removeProperty("--featured-bg");
        return;
      }

      featuredImg.src = p.src;
      featured.style.setProperty("--featured-bg", `url("${p.src}")`);
      featuredTitle.textContent = `ä»Šæ—¥ã®å…œï¼š${typeLabel(p.type)}`;
      featuredSub.textContent = `${p.date || ""} / ${p.caption || ""}`.trim();

      featured.onclick = (e)=>{
        e.preventDefault();
        const idx = visibleCards().findIndex(x=>x.dataset.id === p.id);
        openLightbox(idx !== -1 ? idx : 0);
      };
    }

    // ===== Lightbox =====
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightboxImg");
    const lightboxCap = document.getElementById("lightboxCap");
    const lbPanel = document.getElementById("lbPanel");
    const closeBtn = document.getElementById("lightboxClose");
    const prevBtn = document.getElementById("lightboxPrev");
    const nextBtn = document.getElementById("lightboxNext");

    let currentIndex = -1;

    function visibleCards(){
      return Array.from(grid.querySelectorAll(".gCard"));
    }

    function setInfoPanel(card){
      const title = card.dataset.title || "";
      const c = card.dataset.cultivar || "";
      const d = card.dataset.date || "";
      const a = card.dataset.author || "";
      const t = typeLabel(card.dataset.type || "");
      const flag = countryFlag(card.dataset.country || "");
      const likes = card.dataset.likes || "0";
      const note = card.dataset.note || "";
      const tag = card.dataset.tag || "";
      const liked = card.dataset.liked === "true";

      lbPanel.innerHTML = `
        <div class="lbTitle">${escapeHtml(title || c || "å…œä¸¸")}</div>
        <div class="lbPills">
          ${t ? `<span class="lbPill">${escapeHtml(t)}</span>` : ""}
          ${d ? `<span class="lbPill">${escapeHtml(d)}</span>` : ""}
          ${a ? `<span class="lbPill">by ${escapeHtml(a)}</span>` : ""}
          ${tag ? `<span class="lbPill">#${escapeHtml(tag)}</span>` : ""}
          ${flag ? `<span class="lbPill">${escapeHtml(flag)}</span>` : ""}
          <span class="lbPill">${liked ? "â™¥" : "â™¡"} ${escapeHtml(likes)}</span>
        </div>
        <div class="lbNote">${escapeHtml(note || "ï¼ˆãƒ¡ãƒ¢ã¯æœªç™»éŒ²ï¼‰")}</div>
      `;
    }

    function showAt(index){
      const cards = visibleCards();
      if (!cards.length) return;

      resetZoom();
      currentIndex = (index + cards.length) % cards.length;

      const card = cards[currentIndex];
      lightboxImg.src = card.dataset.src;
      lightboxCap.textContent = [card.dataset.title || "", card.dataset.date || ""].filter(Boolean).join(" / ");
      setInfoPanel(card);
    }

    function openLightbox(index){
      document.body.classList.add("lb-open");
      lightbox.classList.add("open");
      lightbox.setAttribute("aria-hidden", "false");
      showAt(index);
    }

    function closeLightbox(){
      document.body.classList.remove("lb-open");
      resetZoom();
      lightbox.classList.remove("open");
      lightbox.setAttribute("aria-hidden", "true");
      lightboxImg.src = "";
      lbPanel.innerHTML = "";
      currentIndex = -1;
    }

    function next(){ if (currentIndex !== -1) showAt(currentIndex + 1); }
    function prev(){ if (currentIndex !== -1) showAt(currentIndex - 1); }

    function syncCardHandlers(){
      visibleCards().forEach((card, i)=>{
        card.onclick = ()=> openLightbox(i);
      });
    }

    nextBtn.addEventListener("click", next);
    prevBtn.addEventListener("click", prev);
    closeBtn.addEventListener("click", closeLightbox);

    // ===== Zoom / Pan / Swipe =====
    let scale = 1, panX = 0, panY = 0;
    let mousePanning=false, mouseStartX=0, mouseStartY=0;
    let pinching=false, pinchStartDist=0, pinchStartScale=1, pinchImgX=0, pinchImgY=0;
    let touchPanning=false, touchStartX=0, touchStartY=0;
    let swipeStartX=0, swipeStartY=0, swiping=false;

    const clamp = (v, min, max) => Math.min(max, Math.max(min, v));

    function applyTransform(){
      lightboxImg.classList.toggle("zoomed", scale > 1.01);
      lightboxImg.style.transformOrigin = "50% 50%";
      lightboxImg.style.transform = `translate3d(${panX}px, ${panY}px, 0) scale(${scale})`;
    }
    function resetZoom(){
      scale=1; panX=0; panY=0; applyTransform();
    }
    function toggleZoomAt(clientX, clientY){
      const rect = lightboxImg.getBoundingClientRect();
      const px = clientX - rect.left;
      const py = clientY - rect.top;
      if (scale > 1.01){ resetZoom(); return; }
      const newScale = 2;
      const imgX = (px - panX) / scale;
      const imgY = (py - panY) / scale;
      scale = newScale;
      panX = px - imgX * scale;
      panY = py - imgY * scale;
      applyTransform();
    }

    lightboxImg.addEventListener("dblclick", (e)=>{
      if (!lightbox.classList.contains("open")) return;
      e.preventDefault();
      toggleZoomAt(e.clientX, e.clientY);
    });

    lightbox.addEventListener("wheel", (e)=>{
      if (!lightbox.classList.contains("open")) return;
      e.preventDefault();

      const rect = lightboxImg.getBoundingClientRect();
      const cx = e.clientX, cy = e.clientY;
      const px = (cx < rect.left || cx > rect.right) ? (rect.left + rect.width/2) : cx;
      const py = (cy < rect.top  || cy > rect.bottom) ? (rect.top  + rect.height/2) : cy;
      const localX = px - rect.left;
      const localY = py - rect.top;

      const imgX = (localX - panX) / scale;
      const imgY = (localY - panY) / scale;

      const zoomFactor = e.deltaY < 0 ? 1.12 : 1/1.12;
      scale = clamp(scale * zoomFactor, 1, 6);

      panX = localX - imgX * scale;
      panY = localY - imgY * scale;

      if (scale <= 1.01) resetZoom();
      else applyTransform();
    }, { passive:false });

    lightboxImg.addEventListener("mousedown", (e)=>{
      if (!lightbox.classList.contains("open")) return;
      if (scale <= 1.01) return;
      mousePanning = true;
      mouseStartX = e.clientX - panX;
      mouseStartY = e.clientY - panY;
    });
    document.addEventListener("mousemove", (e)=>{
      if (!mousePanning) return;
      panX = e.clientX - mouseStartX;
      panY = e.clientY - mouseStartY;
      applyTransform();
    });
    document.addEventListener("mouseup", ()=>{ mousePanning=false; });

    function dist(t1,t2){ return Math.hypot(t2.clientX-t1.clientX, t2.clientY-t1.clientY); }
    function mid(t1,t2){ return { x:(t1.clientX+t2.clientX)/2, y:(t1.clientY+t2.clientY)/2 }; }

    lightbox.addEventListener("touchstart", (e)=>{
      if (!lightbox.classList.contains("open")) return;

      if (e.touches.length === 2){
        pinching=true; touchPanning=false; swiping=false;
        const t1=e.touches[0], t2=e.touches[1];
        pinchStartDist=dist(t1,t2);
        pinchStartScale=scale;
        const m=mid(t1,t2);
        const rect=lightboxImg.getBoundingClientRect();
        const localX=m.x-rect.left;
        const localY=m.y-rect.top;
        pinchImgX=(localX - panX)/scale;
        pinchImgY=(localY - panY)/scale;
        return;
      }

      if (e.touches.length === 1){
        const t=e.touches[0];
        if (scale > 1.01){
          touchPanning=true; swiping=false;
          touchStartX=t.clientX - panX;
          touchStartY=t.clientY - panY;
        }else{
          swiping=true; touchPanning=false;
          swipeStartX=t.clientX; swipeStartY=t.clientY;
        }
      }
    }, { passive:false });

    lightbox.addEventListener("touchmove", (e)=>{
      if (!lightbox.classList.contains("open")) return;

      if (pinching && e.touches.length === 2){
        e.preventDefault();
        const t1=e.touches[0], t2=e.touches[1];
        const ratio=dist(t1,t2)/pinchStartDist;
        scale = clamp(pinchStartScale * ratio, 1, 4);

        const m=mid(t1,t2);
        const rect=lightboxImg.getBoundingClientRect();
        const localX=m.x-rect.left;
        const localY=m.y-rect.top;

        panX = localX - pinchImgX * scale;
        panY = localY - pinchImgY * scale;

        if (scale <= 1.01) resetZoom();
        else applyTransform();
        return;
      }

      if (touchPanning && e.touches.length === 1 && scale > 1.01){
        e.preventDefault();
        const t=e.touches[0];
        panX = t.clientX - touchStartX;
        panY = t.clientY - touchStartY;
        applyTransform();
        return;
      }

      if (swiping && e.touches.length === 1 && scale <= 1.01){
        const t=e.touches[0];
        const dx=t.clientX - swipeStartX;
        const dy=t.clientY - swipeStartY;
        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 10) e.preventDefault();
      }
    }, { passive:false });

    lightbox.addEventListener("touchend", (e)=>{
      if (!lightbox.classList.contains("open")) return;
      if (e.touches.length < 2) pinching=false;

      if (swiping && scale <= 1.01){
        const t=e.changedTouches[0];
        const dx=t.clientX - swipeStartX;
        const dy=t.clientY - swipeStartY;
        const SWIPE_X=45, SWIPE_Y=60;
        if (Math.abs(dx) > SWIPE_X && Math.abs(dy) < SWIPE_Y){
          if (dx < 0) next(); else prev();
        }
      }
      swiping=false; touchPanning=false;
    }, { passive:true });

    let lastTap=0;
    lightboxImg.addEventListener("touchend", (e)=>{
      if (!lightbox.classList.contains("open")) return;
      if (e.changedTouches.length !== 1) return;
      if (pinching) return;

      const now=Date.now();
      const dt=now - lastTap;
      if (dt < 280 && dt > 30){
        const t=e.changedTouches[0];
        toggleZoomAt(t.clientX, t.clientY);
        lastTap=0;
      }else{
        lastTap=now;
      }
    }, { passive:true });

    // ===== Events =====
    chips.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        chips.forEach(b=>b.classList.remove("is-active"));
        btn.classList.add("is-active");
        activeType = btn.dataset.filter;
        typeSel.value = (activeType === "fav") ? "fav" : (activeType === "all" ? "all" : activeType);
        shown = 8; // âœ… ãƒ•ã‚£ãƒ«ã‚¿å¤‰ãˆãŸã‚‰è¡¨ç¤ºæ•°ãƒªã‚»ãƒƒãƒˆ
        applyFilters();
      });
    });

    searchEl.addEventListener("input", ()=>{ shown = 8; applyFilters(); });
    typeSel.addEventListener("change", ()=>{
      activeType = typeSel.value;
      chips.forEach(b=>b.classList.toggle("is-active", b.dataset.filter === activeType));
      if (activeType === "all") chips[0].classList.add("is-active");
      shown = 8; // âœ…
      applyFilters();
    });
    sortEl.addEventListener("change", ()=>{ shown = 8; applyFilters(); });

    resetEl.addEventListener("click", ()=>{
      activeType="all";
      shown = 8;
      chips.forEach(b=>b.classList.remove("is-active"));
      chips[0].classList.add("is-active");
      searchEl.value="";
      typeSel.value="all";
      sortEl.value="new";
      applyFilters();
    });

    moreBtn.addEventListener("click", ()=>{
      shown += 8;
      render();
    });

    // ===== init =====
    (async ()=>{
      try{
        allPosts = await loadPosts();

        // â¤ï¸ likeæƒ…å ±ã‚’ã¾ã¨ã‚ã¦å–å¾—ã—ã¦ã€allPostsã¸åæ˜ 
        const ids = allPosts.map(p=>p.id);
        const likeData = await fetchLikesMap(ids);

        allPosts.forEach(p=>{
          p.likes = Number(likeData.counts?.[p.id] ?? 0);
          p.liked = !!likeData.liked?.[p.id];
        });

        allPosts = sortPosts(allPosts);
        applyFilters();
      }catch(err){
        console.error(err);
        document.body.classList.add("load-failed");
        document.body.classList.add("is-empty");
        grid.innerHTML = `
          <div style="padding:14px;border:1px solid rgba(0,0,0,.10);border-radius:14px;background:rgba(255,255,255,.6);">
            <b>Gallery load failed.</b><br>
            Worker ã® <code>/list?v=2</code> ãŒèª­ã‚ãªã„ï¼ˆCORS/404/JSONä¸æ­£ï¼‰å¯èƒ½æ€§ã€‚<br>
            ã¾ãš <code>${WORKER_ORIGIN}/list?v=2</code> ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦JSONãŒè¿”ã‚‹ã‹ç¢ºèªã—ã¦ã­ã€‚
          </div>
        `;
      }
    })();
  </script>
</body>
</html>

