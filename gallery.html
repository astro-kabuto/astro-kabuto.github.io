<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gallery | Astro Kabuto</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <header class="header">
    <a class="brand" href="index.html">
      <strong>Astro Kabuto</strong><br>
      <small>兜丸の成長記録サイト</small>
    </a>
  </header>

  <main class="container">
    <h1>Gallery</h1>
    <p class="sub">兜丸の写真記録</p>

    <div class="grid">
      <img class="gimg"src="images/gallery/2026-01-09_kabuto (1).jpg">
      <img class="gimg"src="images/gallery/2026-01-09_kabuto (2).jpg">
      <img class="gimg"src="images/gallery/2026-01-09_kabuto (3).jpg">
      <img class="gimg"src="images/gallery/2026-01-09_kabuto (4).jpg">
      <img class="gimg"src="images/gallery/2026-01-09_kabuto (5).jpg">
      <img class="gimg"src="images/gallery/2026-01-09_kabuto (6).jpg">
      <img class="gimg"src="images/gallery/2026-01-09_kabuto (7).jpg">
      <img class="gimg"src="images/gallery/2026-01-09_kabuto (8).jpg">
    </div>

    <p style="margin-top:40px;">
      <a href="index.html">← Homeへ戻る</a>
    </p>
  </main>
 <!-- Lightbox -->
<div id="lightbox" class="lightbox" aria-hidden="true">
  <button class="lightbox-btn prev" id="lightboxPrev" aria-label="Prev">‹</button>

  <figure class="lightbox-figure">
    <button class="lightbox-close" id="lightboxClose" aria-label="Close">×</button>
    <img id="lightboxImg" alt="">
    <figcaption id="lightboxCap" class="lightbox-cap"></figcaption>
  </figure>

  <button class="lightbox-btn next" id="lightboxNext" aria-label="Next">›</button>
</div>
<script>
  const lightbox = document.getElementById("lightbox");
  const lightboxImg = document.getElementById("lightboxImg");
  const lightboxCap = document.getElementById("lightboxCap");
  const closeBtn = document.getElementById("lightboxClose");
  const prevBtn = document.getElementById("lightboxPrev");
  const nextBtn = document.getElementById("lightboxNext");

  const images = Array.from(document.querySelectorAll(".gimg"));
  let currentIndex = -1;

  function showAt(index) {
    if (!images.length) return;
    currentIndex = (index + images.length) % images.length; // ループ
    const img = images[currentIndex];
    lightboxImg.src = img.src;
    lightboxCap.textContent = img.dataset.caption || "";
  }

  function openLightbox(index) {
    lightbox.classList.add("open");
    lightbox.setAttribute("aria-hidden", "false");
    showAt(index);
  }

  function closeLightbox() {
    lightbox.classList.remove("open");
    lightbox.setAttribute("aria-hidden", "true");
    lightboxImg.src = "";
    currentIndex = -1;
  }

  function next() { if (currentIndex !== -1) showAt(currentIndex + 1); }
  function prev() { if (currentIndex !== -1) showAt(currentIndex - 1); }

  images.forEach((img, i) => {
    img.addEventListener("click", () => openLightbox(i));
  });

  nextBtn.addEventListener("click", next);
  prevBtn.addEventListener("click", prev);
  closeBtn.addEventListener("click", closeLightbox);

  // 背景クリックで閉じる
  lightbox.addEventListener("click", (e) => {
    if (e.target === lightbox) closeLightbox();
  });

  // 画像の左右クリックで移動（左=prev / 右=next）
  lightboxImg.addEventListener("click", (e) => {
    const rect = lightboxImg.getBoundingClientRect();
    const x = e.clientX - rect.left;
    if (x < rect.width / 2) prev();
    else next();
  });

  // キーボード操作
  document.addEventListener("keydown", (e) => {
    if (!lightbox.classList.contains("open")) return;
    if (e.key === "Escape") closeLightbox();
    if (e.key === "ArrowRight") next();
    if (e.key === "ArrowLeft") prev();
  });
  // --- Swipe (mobile) ---
  let touchStartX = 0;
  let touchStartY = 0;
  let touchEndX = 0;
  let touchEndY = 0;

  function handleSwipe() {
    const dx = touchEndX - touchStartX;
    const dy = touchEndY - touchStartY;

    // 縦スクロールを邪魔しない（横スワイプが強いときだけ反応）
    if (Math.abs(dx) < 40 || Math.abs(dx) < Math.abs(dy)) return;

    if (dx < 0) next();   // 左にスワイプ → 次へ
    else prev();          // 右にスワイプ → 前へ
  }

  // lightbox 全体でスワイプを取る
  lightbox.addEventListener("touchstart", (e) => {if (scale > 1.01 || e.touches.length > 1) return;

    if (!lightbox.classList.contains("open")) return;
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
  }, { passive: true });

  lightbox.addEventListener("touchend", (e) => {if (scale > 1.01) return;

    if (!lightbox.classList.contains("open")) return;
    touchEndX = e.changedTouches[0].screenX;
    touchEndY = e.changedTouches[0].screenY;
    handleSwipe();
  }, { passive: true });
  // --- Zoom (double click / double tap) + drag to pan ---
   // --- Zoom: double tap/click + pinch zoom + pan ---
  let scale = 1;
  let panX = 0, panY = 0;

  let isPanning = false;
  let startX = 0, startY = 0;

  // pinch
  let pinching = false;
  let pinchStartDist = 0;
  let pinchStartScale = 1;
  let pinchImgX = 0, pinchImgY = 0; // image-space point under fingers

  const clamp = (v, min, max) => Math.min(max, Math.max(min, v));

  function applyTransform() {
    lightboxImg.classList.toggle("zoomed", scale > 1.01);
    lightboxImg.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
  }

  function resetZoom() {
    scale = 1;
    panX = 0; panY = 0;
    applyTransform();
  }

  function toggleZoom() {
    if (scale > 1.01) resetZoom();
    else {
      scale = 2;
      panX = 0; panY = 0;
      applyTransform();
    }
  }

  // PC: ダブルクリックでズーム
  lightboxImg.addEventListener("dblclick", (e) => {
    e.preventDefault();
    toggleZoom();
  });

  // Mobile: ダブルタップでズーム
  let lastTap = 0;
  lightboxImg.addEventListener("touchend", (e) => {
    const now = Date.now();
    if (now - lastTap < 300 && !pinching) {
      e.preventDefault();
      toggleZoom();
      lastTap = 0;
    } else {
      lastTap = now;
    }
  }, { passive: false });

  // pan (PC)
  lightboxImg.addEventListener("mousedown", (e) => {
    if (scale <= 1.01) return;
    isPanning = true;
    startX = e.clientX - panX;
    startY = e.clientY - panY;
  });

  document.addEventListener("mousemove", (e) => {
    if (!isPanning) return;
    panX = e.clientX - startX;
    panY = e.clientY - startY;
    applyTransform();
  });

  document.addEventListener("mouseup", () => {
    isPanning = false;
  });

  // helper for pinch distance
  function dist(t1, t2) {
    const dx = t2.clientX - t1.clientX;
    const dy = t2.clientY - t1.clientY;
    return Math.hypot(dx, dy);
  }

  function mid(t1, t2) {
    return {
      x: (t1.clientX + t2.clientX) / 2,
      y: (t1.clientY + t2.clientY) / 2
    };
  }

  // touch start: pan or pinch
  lightboxImg.addEventListener("touchstart", (e) => {
    if (e.touches.length === 2) {
      // begin pinch
      pinching = true;
      isPanning = false;

      const t1 = e.touches[0];
      const t2 = e.touches[1];

      pinchStartDist = dist(t1, t2);
      pinchStartScale = scale;

      // compute image-space point under midpoint (keep it fixed while zooming)
      const m = mid(t1, t2);
      pinchImgX = (m.x - panX) / scale;
      pinchImgY = (m.y - panY) / scale;

    } else if (e.touches.length === 1 && scale > 1.01) {
      // begin pan
      pinching = false;
      isPanning = true;
      startX = e.touches[0].clientX - panX;
      startY = e.touches[0].clientY - panY;
    }
  }, { passive: true });

  // touch move: pan or pinch
  lightboxImg.addEventListener("touchmove", (e) => {
    if (pinching && e.touches.length === 2) {
      e.preventDefault(); // important (we set passive:false)
      const t1 = e.touches[0];
      const t2 = e.touches[1];

      const d = dist(t1, t2);
      const ratio = d / pinchStartDist;

      // scale update
      const newScale = clamp(pinchStartScale * ratio, 1, 4);
      scale = newScale;

      // keep midpoint fixed
      const m = mid(t1, t2);
      panX = m.x - pinchImgX * scale;
      panY = m.y - pinchImgY * scale;

      applyTransform();

    } else if (isPanning && e.touches.length === 1) {
      const t = e.touches[0];
      panX = t.clientX - startX;
      panY = t.clientY - startY;
      applyTransform();
    }
  }, { passive: false });

  lightboxImg.addEventListener("touchend", (e) => {
    if (e.touches.length < 2) pinching = false;
    if (e.touches.length === 0) isPanning = false;

    // scale が 1 に戻ったら pan もリセット（ズレ防止）
    if (scale <= 1.01) resetZoom();
  }, { passive: true });

  // 画像切り替え/閉じる時はズーム解除
  const _closeLightbox2 = closeLightbox;
  closeLightbox = function () {
    resetZoom();
    _closeLightbox2();
  };

  const _showAt2 = showAt;
  showAt = function (index) {
    resetZoom();
    _showAt2(index);
  };
</script>



</body>
</html>
