<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Admin | Astro Kabuto</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    main.wrap{ padding-top:16px; }
    .top{
      max-width: 1100px; margin: 0 auto;
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      background: rgba(255,255,255,.75);
      border:1px solid rgba(0,0,0,.10);
      border-radius: 18px;
      padding: 12px 14px;
      box-shadow: 0 18px 55px rgba(0,0,0,.08);
    }
    .top h1{ margin:0; font-size: 16px; }
    .muted{ color: rgba(0,0,0,.55); font-size: 12px; }
    button{
      height: 40px;
      border-radius: 999px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff; padding:0 12px;
      cursor:pointer; font-weight: 900;
    }
    button.primary{ background: rgba(0,113,227,.12); border-color: rgba(0,113,227,.18); }
    .list{
      max-width: 1100px; margin: 12px auto 0;
      display:grid; gap:12px;
    }
    .card{
      display:grid;
      grid-template-columns: 220px 1fr;
      gap:12px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      border-radius: 16px;
      overflow:hidden;
    }
    .thumb{ background: rgba(0,0,0,.04); display:grid; place-items:center; }
    .thumb img{ width:100%; height:100%; object-fit:contain; max-height:220px; }
    .body{ padding:12px; }
    .title{ font-weight: 900; margin-bottom:6px; }
    .meta{ color: rgba(0,0,0,.55); font-size: 12px; margin-bottom: 10px; }
    .note{ font-size: 13px; line-height: 1.6; margin-bottom: 10px; white-space: pre-wrap; }
    .btns{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .btn-ok{ background: rgba(0,113,227,.12); border-color: rgba(0,113,227,.18); }
    .btn-ng{ background: rgba(180,35,24,.10); border-color: rgba(180,35,24,.18); }
    .msg{ margin-top:10px; font-size: 12px; color: rgba(0,0,0,.55); }
    @media (max-width: 720px){
      .card{ grid-template-columns: 1fr; }
      .thumb img{ max-height: 260px; }
    }
  </style>
</head>
<body>

<main class="wrap">
  <div class="top">
    <h1>Admin / Pending</h1>
    <span class="muted" id="count"></span>
    <button class="primary" id="reload">更新</button>
    <button id="logout">ログアウト（token削除）</button>
    <span class="muted" id="status"></span>
  </div>

  <div class="list" id="list"></div>
</main>

<script>
  // ★あなたの Worker のURLに合わせて
  const API_ORIGIN = "https://astro-kabuto-gallery-worker.gigasantrinn1226.workers.dev";
  const KEY = "AK_ADMIN_TOKEN";

  const elList = document.getElementById("list");
  const elCount = document.getElementById("count");
  const elStatus = document.getElementById("status");

  function token(){
    return (localStorage.getItem(KEY) || "").trim();
  }

  function setStatus(msg){ elStatus.textContent = msg || ""; }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function fileUrl(r2_key){
    return `${API_ORIGIN}/files/${encodeURIComponent(r2_key)}`;
  }

  async function api(path, opts={}){
    const t = token();
    if(!t){
      location.href = "admin-link.html";
      return;
    }
    const headers = Object.assign({}, opts.headers || {}, {
      "Authorization": "Bearer " + t,
    });
    return fetch(API_ORIGIN + path, { ...opts, headers });
  }

  function renderItem(row){
    let meta = {};
    try { meta = JSON.parse(row.caption || "{}"); } catch {}

    const title = escapeHtml(meta.title || "(no title)");
    const note  = escapeHtml(meta.note || "");
    const created = escapeHtml(row.created_at || "");
    const id = escapeHtml(row.id || "");
    const img = fileUrl(row.r2_key);

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="thumb"><img src="${img}" alt=""></div>
      <div class="body">
        <div class="title">${title}</div>
        <div class="meta">${created} / id: <code>${id}</code></div>
        ${note ? `<div class="note">${note}</div>` : ""}
        <div class="btns">
          <button class="btn-ok" data-approve="${row.id}">承認</button>
          <button class="btn-ng" data-reject="${row.id}">却下</button>
          <a href="${img}" target="_blank" rel="noopener">画像を開く</a>
        </div>
        <div class="msg"></div>
      </div>
    `;
    return div;
  }

  async function load(){
    setStatus("読み込み中...");
    elList.innerHTML = "";
    try{
      const res = await api("/admin/pending", { method: "GET" });
      if(!res) return;

      const j = await res.json().catch(()=>null);
      if(!res.ok || !j || !j.ok){
        setStatus("失敗: " + (j?.error || res.status));
        if(res.status === 401){
          // tokenが違う
          localStorage.removeItem(KEY);
          setTimeout(()=> location.href="admin-link.html", 500);
        }
        return;
      }

      const items = j.items || [];
      elCount.textContent = `(${items.length})`;
      setStatus("");

      if(!items.length){
        elList.innerHTML = `<div class="muted" style="max-width:1100px;margin:10px auto;">pending がありません。</div>`;
        return;
      }

      for(const row of items){
        elList.appendChild(renderItem(row));
      }
    }catch(e){
      setStatus("エラー: " + (e?.message || e));
    }
  }

  async function approve(id, card){
  const msg = card.querySelector(".msg");
  msg.textContent = "承認中...";
  const res = await api(`/admin/approve?id=${encodeURIComponent(id)}`, { method:"POST" });
  const j = await res.json().catch(()=>null);
  if(!res.ok || !j || !j.ok){
    msg.textContent = "失敗: " + (j?.error || res.status);
    return;
  }

  msg.textContent = "OK";

  // ★ギャラリーを即確認（キャッシュ回避）
  window.open("gallery.html?t=" + Date.now(), "_blank", "noopener");

  setTimeout(()=> card.remove(), 250);
}


  async function reject(id, card){
    const msg = card.querySelector(".msg");
    msg.textContent = "却下中...（R2削除もします）";
    const res = await api(`/admin/reject?id=${encodeURIComponent(id)}`, { method:"POST" });
    const j = await res.json().catch(()=>null);
    if(!res.ok || !j || !j.ok){
      msg.textContent = "失敗: " + (j?.error || res.status);
      return;
    }
    msg.textContent = `OK（R2削除: ${j.r2_deleted || 0}）`;
    setTimeout(()=> card.remove(), 250);
  }

  document.getElementById("reload").addEventListener("click", load);
  document.getElementById("logout").addEventListener("click", ()=>{
    localStorage.removeItem(KEY);
    location.href = "admin-link.html";
  });

  document.addEventListener("click", (e)=>{
    const btnA = e.target.closest("[data-approve]");
    const btnR = e.target.closest("[data-reject]");
    const card = e.target.closest(".card");
    if(btnA) approve(btnA.getAttribute("data-approve"), card);
    if(btnR) reject(btnR.getAttribute("data-reject"), card);
  });

  load();
</script>
</body>
</html>

